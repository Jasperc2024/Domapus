(function(){"use strict";let a=null;function w(i,r){if(!i)return 0;const l=i[r];return typeof l=="number"&&isFinite(l)?l:0}self.onmessage=async i=>{const{id:r,type:l,data:v}=i.data;a&&a.abort(),a=new AbortController;const m=a.signal;try{switch(l){case"LOAD_AND_PROCESS_DATA":{let s=function(o){const t=[...o].filter(e=>e>0).sort((e,n)=>e-n);if(t.length===0)return{min:0,max:1};const d=e=>{const n=Math.floor(e*(t.length-1));return t[n]};return{min:d(.05),max:d(.95)}};const{url:b,selectedMetric:k}=v;self.postMessage({type:"PROGRESS",data:{phase:"Fetching market data..."}});const c=await fetch(b,{signal:m});if(!c.ok)throw new Error(`Fetch failed: ${c.status}`);const E=await c.arrayBuffer();let _;try{const o=new TextDecoder().decode(E);if(o.startsWith("version https://git-lfs.github.com"))throw console.error("[Worker] Received Git LFS pointer instead of actual data file"),new Error("Data file not available. The server returned a placeholder instead of actual data. Please try refreshing or contact support.");if(_=JSON.parse(o),!_||typeof _!="object")throw new Error("Invalid data format: expected object")}catch(o){console.error("[Worker] JSON parse failed:",o);const t=o instanceof Error?o.message:"Unknown error";throw t.includes("Unexpected token")||t.includes("JSON")?new Error("Decoding failed: The data file appears to be corrupted or incomplete. Please try refreshing the page."):new Error("Failed to load data: "+t)}const{last_updated_utc:S,zip_codes:y}=_;if(!y)throw new Error("Missing zip_codes data");self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes..."}});const u={},f=[],p=Object.entries(y);for(let o=0;o<p.length;o++){if(m.aborted)return;const[t,d]=p[o],e=d??{},n={zipCode:t,city:e.city??null,county:e.county??null,state:e.state??null,metro:e.metro??null,latitude:e.latitude??e.lat??null,longitude:e.longitude??e.lng??null,period_end:e.period_end??null,zhvi:e.zhvi??null,zhvi_mom:e.zhvi_mom??null,zhvi_yoy:e.zhvi_yoy??null,median_sale_price:e.median_sale_price??null,median_sale_price_mom:e.median_sale_price_mom??null,median_sale_price_yoy:e.median_sale_price_yoy??null,median_list_price:e.median_list_price??null,median_list_price_mom:e.median_list_price_mom??null,median_list_price_yoy:e.median_list_price_yoy??null,median_ppsf:e.median_ppsf??null,median_ppsf_mom:e.median_ppsf_mom??null,median_ppsf_yoy:e.median_ppsf_yoy??null,homes_sold:e.homes_sold??null,homes_sold_mom:e.homes_sold_mom??null,homes_sold_yoy:e.homes_sold_yoy??null,pending_sales:e.pending_sales??null,pending_sales_mom:e.pending_sales_mom??null,pending_sales_yoy:e.pending_sales_yoy??null,new_listings:e.new_listings??null,new_listings_mom:e.new_listings_mom??null,new_listings_yoy:e.new_listings_yoy??null,inventory:e.inventory??null,inventory_mom:e.inventory_mom??null,inventory_yoy:e.inventory_yoy??null,median_dom:e.median_dom??null,median_dom_mom:e.median_dom_mom??null,median_dom_yoy:e.median_dom_yoy??null,avg_sale_to_list_ratio:e.avg_sale_to_list_ratio??null,avg_sale_to_list_mom:e.avg_sale_to_list_mom??null,avg_sale_to_list_ratio_yoy:e.avg_sale_to_list_ratio_yoy??null,sold_above_list:e.sold_above_list??null,sold_above_list_mom:e.sold_above_list_mom??null,sold_above_list_yoy:e.sold_above_list_yoy??null,off_market_in_two_weeks:e.off_market_in_two_weeks??null,off_market_in_two_weeks_mom:e.off_market_in_two_weeks_mom??null,off_market_in_two_weeks_yoy:e.off_market_in_two_weeks_yoy??null};u[t]=n;const h=w(n,k);h>0&&f.push(h),o%2e3===0&&self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes...",processed:o,total:p.length}})}const g=s(f);console.log(`[Worker] Data processed: ${Object.keys(u).length} ZIPs, bounds:`,g),self.postMessage({type:"DATA_PROCESSED",id:r,data:{zip_codes:u,last_updated_utc:S,bounds:g}});break}}}catch(s){m.aborted||(console.error("[Worker] Error:",s),self.postMessage({type:"ERROR",id:r,error:s instanceof Error?s.message:"Unknown error"}))}}})();
