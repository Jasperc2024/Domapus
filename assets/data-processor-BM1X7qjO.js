(function(){"use strict";let c=null;function R(l,n){if(!l)return 0;const o=l[n];return typeof o=="number"&&isFinite(o)?o:0}self.onmessage=async l=>{const{id:n,type:o,data:h}=l.data;console.log(`[Worker] Received message: ${o}`,{id:n,data:h}),c&&(c.abort(),console.log("[Worker] Aborted previous operation")),c=new AbortController;const d=c.signal;try{switch(o){case"LOAD_AND_PROCESS_DATA":{let a=function(e){const s=[...e].filter(t=>t>0).sort((t,g)=>t-g);if(s.length===0)return{min:0,max:1};const r=t=>{const g=Math.floor(t*(s.length-1));return s[g]};return{min:r(.05),max:r(.95)}};const{url:b,selectedMetric:y}=h;console.log(`[Worker] Loading data from: ${b}, metric: ${y}`),self.postMessage({type:"PROGRESS",data:{phase:"Fetching market data..."}});const i=await fetch(b,{signal:d});if(!i.ok)throw new Error(`Fetch failed: ${i.status}`);console.log(`[Worker] Fetch successful, status: ${i.status}`);const k=await i.arrayBuffer();console.log(`[Worker] Received buffer size: ${k.byteLength} bytes`);let m;try{const e=new TextDecoder().decode(k);m=JSON.parse(e),console.log("[Worker] JSON parsed successfully")}catch(e){throw console.error("[Worker] JSON parse failed:",e),new Error("Failed to parse JSON: "+e.message)}const{last_updated_utc:w,zip_codes:u}=m;if(!u)throw new Error("Missing zip_codes data");console.log(`[Worker] Found ${Object.keys(u).length} ZIP codes, last updated: ${w}`),self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes..."}});const f={},O=[],p=Object.entries(u);for(let e=0;e<p.length;e++){if(d.aborted)return;const[s,r]=p[e];r.zipCode=s,f[s]=r;const t=R(r,y);t>0&&O.push(t),e%2e3===0&&self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes...",processed:e,total:p.length}})}const S=a(O);console.log(`[Worker] Data processed: ${Object.keys(f).length} ZIPs, bounds:`,S),self.postMessage({type:"DATA_PROCESSED",id:n,data:{zip_codes:f,last_updated_utc:w,bounds:S}});break}}}catch(a){d.aborted||(console.error("[Worker] Error:",a),self.postMessage({type:"ERROR",id:n,error:a instanceof Error?a.message:"Unknown error"}))}}})();
