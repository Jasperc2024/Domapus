(function(){"use strict";function _(n,r){if(!n)return 0;const c={"median-sale-price":"median_sale_price","median-list-price":"median_list_price","median-dom":"median_dom",inventory:"inventory","new-listings":"new_listings","homes-sold":"homes_sold","sale-to-list-ratio":"avg_sale_to_list_ratio","homes-sold-above-list":"sold_above_list","off-market-2-weeks":"off_market_in_two_weeks"}[r];if(!c||!n)return 0;const a=n[c];return typeof a=="number"&&isFinite(a)?a:0}self.onmessage=async n=>{var a;const{id:r,type:m,data:c}=n.data;try{switch(m){case"LOAD_AND_PROCESS_DATA":{const{url:e,selectedMetric:f}=c;self.postMessage({type:"PROGRESS",data:{phase:"Fetching market data..."}});const l=await fetch(e);if(!l.ok)throw new Error(`Fetch failed with status: ${l.status}`);const u=await l.json(),{last_updated_utc:s,zip_codes:t}=u;if(!t)throw new Error("Data file is missing 'zip_codes' key.");const p={};for(const[i,o]of Object.entries(t))o.zipCode=i,p[i]=o;const d=[];for(const i of Object.values(p)){const o=_(i,f);o>0&&d.push(o)}d.sort((i,o)=>i-o);const g={min:d[0]||0,max:d[d.length-1]||0};self.postMessage({type:"DATA_PROCESSED",id:r,data:{zip_codes:p,last_updated_utc:s,bounds:g}});break}case"PROCESS_GEOJSON":{const{geojson:e,zipData:f,selectedMetric:l}=c;if(!e||!Array.isArray(e.features)){console.error("[Worker] Invalid or missing GeoJSON data received.",e),self.postMessage({type:"ERROR",id:r,error:"Invalid GeoJSON data provided to worker."});return}self.postMessage({type:"PROGRESS",data:{phase:"Processing map shapes"}});const u=[];for(const s of e.features){if(!s.geometry)continue;const t=(a=s.properties)==null?void 0:a.ZCTA5CE20;if(!t||!f[t])continue;const p=_(f[t],l);s.properties.zipCode=t,s.properties.metricValue=p,u.push(s)}self.postMessage({type:"GEOJSON_PROCESSED",id:r,data:{type:"FeatureCollection",features:u}});break}default:console.warn(`[Worker] Unknown message type: ${m}`)}}catch(e){console.error("‚ùå [Worker] A critical error occurred:",e),self.postMessage({type:"ERROR",id:r,error:e instanceof Error?e.message:"An unknown worker error."})}}})();
