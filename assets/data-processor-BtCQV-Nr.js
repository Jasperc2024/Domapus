(function(){"use strict";function F(i,t,e=0,n=i.length-1,o=P){for(;n>e;){if(n-e>600){const c=n-e+1,h=t-e+1,l=Math.log(c),f=.5*Math.exp(2*l/3),p=.5*Math.sqrt(l*f*(c-f)/c)*(h-c/2<0?-1:1),x=Math.max(e,Math.floor(t-h*f/c+p)),d=Math.min(n,Math.floor(t+(c-h)*f/c+p));F(i,t,x,d,o)}const s=i[t];let a=e,r=n;for(B(i,e,t),o(i[n],s)>0&&B(i,e,n);a<r;){for(B(i,a,r),a++,r--;o(i[a],s)<0;)a++;for(;o(i[r],s)>0;)r--}o(i[e],s)===0?B(i,e,r):(r++,B(i,r,n)),r<=t&&(e=r+1),t<=r&&(n=r-1)}}function B(i,t,e){const n=i[t];i[t]=i[e],i[e]=n}function P(i,t){return i<t?-1:i>t?1:0}class b{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const n=[];if(!w(t,e))return n;const o=this.toBBox,s=[];for(;e;){for(let a=0;a<e.children.length;a++){const r=e.children[a],c=e.leaf?o(r):r;w(t,c)&&(e.leaf?n.push(r):I(t,c)?this._all(r,n):s.push(r))}e=s.pop()}return n}collides(t){let e=this.data;if(!w(t,e))return!1;const n=[];for(;e;){for(let o=0;o<e.children.length;o++){const s=e.children[o],a=e.leaf?this.toBBox(s):s;if(w(t,a)){if(e.leaf||I(t,a))return!0;n.push(s)}}e=n.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let n=0;n<t.length;n++)this.insert(t[n]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const n=this.data;this.data=e,e=n}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=g([]),this}remove(t,e){if(!t)return this;let n=this.data;const o=this.toBBox(t),s=[],a=[];let r,c,h;for(;n||s.length;){if(n||(n=s.pop(),c=s[s.length-1],r=a.pop(),h=!0),n.leaf){const l=D(t,n.children,e);if(l!==-1)return n.children.splice(l,1),s.push(n),this._condense(s),this}!h&&!n.leaf&&I(n,o)?(s.push(n),a.push(r),r=0,c=n,n=n.children[0]):c?(r++,n=c.children[r],h=!1):n=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const n=[];for(;t;)t.leaf?e.push(...t.children):n.push(...t.children),t=n.pop();return e}_build(t,e,n,o){const s=n-e+1;let a=this._maxEntries,r;if(s<=a)return r=g(t.slice(e,n+1)),M(r,this.toBBox),r;o||(o=Math.ceil(Math.log(s)/Math.log(a)),a=Math.ceil(s/Math.pow(a,o-1))),r=g([]),r.leaf=!1,r.height=o;const c=Math.ceil(s/a),h=c*Math.ceil(Math.sqrt(a));A(t,e,n,h,this.compareMinX);for(let l=e;l<=n;l+=h){const f=Math.min(l+h-1,n);A(t,l,f,c,this.compareMinY);for(let p=l;p<=f;p+=c){const x=Math.min(p+c-1,f);r.children.push(this._build(t,p,x,o-1))}}return M(r,this.toBBox),r}_chooseSubtree(t,e,n,o){for(;o.push(e),!(e.leaf||o.length-1===n);){let s=1/0,a=1/0,r;for(let c=0;c<e.children.length;c++){const h=e.children[c],l=R(h),f=T(t,h)-l;f<a?(a=f,s=l<s?l:s,r=h):f===a&&l<s&&(s=l,r=h)}e=r||e.children[0]}return e}_insert(t,e,n){const o=n?t:this.toBBox(t),s=[],a=this._chooseSubtree(o,this.data,e,s);for(a.children.push(t),X(a,o);e>=0&&s[e].children.length>this._maxEntries;)this._split(s,e),e--;this._adjustParentBBoxes(o,s,e)}_split(t,e){const n=t[e],o=n.children.length,s=this._minEntries;this._chooseSplitAxis(n,s,o);const a=this._chooseSplitIndex(n,s,o),r=g(n.children.splice(a,n.children.length-a));r.height=n.height,r.leaf=n.leaf,M(n,this.toBBox),M(r,this.toBBox),e?t[e-1].children.push(r):this._splitRoot(n,r)}_splitRoot(t,e){this.data=g([t,e]),this.data.height=t.height+1,this.data.leaf=!1,M(this.data,this.toBBox)}_chooseSplitIndex(t,e,n){let o,s=1/0,a=1/0;for(let r=e;r<=n-e;r++){const c=_(t,0,r,this.toBBox),h=_(t,r,n,this.toBBox),l=G(c,h),f=R(c)+R(h);l<s?(s=l,o=r,a=f<a?f:a):l===s&&f<a&&(a=f,o=r)}return o||n-e}_chooseSplitAxis(t,e,n){const o=t.leaf?this.compareMinX:N,s=t.leaf?this.compareMinY:z,a=this._allDistMargin(t,e,n,o),r=this._allDistMargin(t,e,n,s);a<r&&t.children.sort(o)}_allDistMargin(t,e,n,o){t.children.sort(o);const s=this.toBBox,a=_(t,0,e,s),r=_(t,n-e,n,s);let c=y(a)+y(r);for(let h=e;h<n-e;h++){const l=t.children[h];X(a,t.leaf?s(l):l),c+=y(a)}for(let h=n-e-1;h>=e;h--){const l=t.children[h];X(r,t.leaf?s(l):l),c+=y(r)}return c}_adjustParentBBoxes(t,e,n){for(let o=n;o>=0;o--)X(e[o],t)}_condense(t){for(let e=t.length-1,n;e>=0;e--)t[e].children.length===0?e>0?(n=t[e-1].children,n.splice(n.indexOf(t[e]),1)):this.clear():M(t[e],this.toBBox)}}function D(i,t,e){if(!e)return t.indexOf(i);for(let n=0;n<t.length;n++)if(e(i,t[n]))return n;return-1}function M(i,t){_(i,0,i.children.length,t,i)}function _(i,t,e,n,o){o||(o=g(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(let s=t;s<e;s++){const a=i.children[s];X(o,i.leaf?n(a):a)}return o}function X(i,t){return i.minX=Math.min(i.minX,t.minX),i.minY=Math.min(i.minY,t.minY),i.maxX=Math.max(i.maxX,t.maxX),i.maxY=Math.max(i.maxY,t.maxY),i}function N(i,t){return i.minX-t.minX}function z(i,t){return i.minY-t.minY}function R(i){return(i.maxX-i.minX)*(i.maxY-i.minY)}function y(i){return i.maxX-i.minX+(i.maxY-i.minY)}function T(i,t){return(Math.max(t.maxX,i.maxX)-Math.min(t.minX,i.minX))*(Math.max(t.maxY,i.maxY)-Math.min(t.minY,i.minY))}function G(i,t){const e=Math.max(i.minX,t.minX),n=Math.max(i.minY,t.minY),o=Math.min(i.maxX,t.maxX),s=Math.min(i.maxY,t.maxY);return Math.max(0,o-e)*Math.max(0,s-n)}function I(i,t){return i.minX<=t.minX&&i.minY<=t.minY&&t.maxX<=i.maxX&&t.maxY<=i.maxY}function w(i,t){return t.minX<=i.maxX&&t.minY<=i.maxY&&t.maxX>=i.minX&&t.maxY>=i.minY}function g(i){return{children:i,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function A(i,t,e,n,o){const s=[t,e];for(;s.length;){if(e=s.pop(),t=s.pop(),e-t<=n)continue;const a=t+Math.ceil((e-t)/n/2)*n;F(i,a,t,e,o),s.push(t,a,a,e)}}let S=null;function C(i,t){if(!i)return 0;const e=i[t];return typeof e=="number"&&isFinite(e)?e:0}let J=null,k={};function j(i,t=7){const e=[...i].sort((s,a)=>s-a),n=Math.ceil(e.length/t),o=[];for(let s=1;s<t;s++)o.push(e[s*n]??e[e.length-1]);return o}self.onmessage=async i=>{const{id:t,type:e,data:n}=i.data;S&&S.abort(),S=new AbortController;const o=S.signal;try{switch(e){case"LOAD_AND_PROCESS_DATA":{const{url:s,selectedMetric:a}=n;self.postMessage({type:"PROGRESS",data:{phase:"Fetching market data..."}});const r=await fetch(s,{signal:o});if(!r.ok)throw new Error(`Fetch failed: ${r.status}`);const c=await r.arrayBuffer();let h;try{const u=new TextDecoder().decode(c);h=JSON.parse(u)}catch(u){throw new Error("Failed to parse JSON: "+u.message)}const{last_updated_utc:l,zip_codes:f}=h;if(!f)throw new Error("Missing zip_codes data");self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes..."}});const p={},x=[],d=Object.entries(f);for(let u=0;u<d.length;u++){if(o.aborted)return;const[E,Y]=d[u];Y.zipCode=E,p[E]=Y;const O=C(Y,a);O>0&&x.push(O),u%2e3===0&&self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes...",processed:u,total:d.length}})}const m={min:Math.min(...x),max:Math.max(...x)};self.postMessage({type:"DATA_PROCESSED",id:t,data:{zip_codes:p,last_updated_utc:l,bounds:m}});break}case"PROCESS_GEOJSON":{const{geojson:s,zipData:a,selectedMetric:r,viewport:c}=n;if(!s?.features)throw new Error("Invalid GeoJSON");self.postMessage({type:"PROGRESS",data:{phase:"Building spatial index..."}});const h=new b,l=[];for(let m of s.features){if(o.aborted)return;const u=m.properties?.ZCTA5CE20;if(!u||!a[u])continue;const[E,Y,O,U]=Z(m);h.insert({minX:E,minY:Y,maxX:O,maxY:U,feature:m}),k[u]=m,l.push(m)}J=h,self.postMessage({type:"PROGRESS",data:{phase:"Filtering viewport..."}});const f=c?h.search(c).map(m=>m.feature):l,p=f.map(m=>C(a[m.properties.ZCTA5CE20],r)),x=j(p),d=["step",["get","metricValue"],"#FFF9B0",...x.flatMap((m,u)=>[m,V(u)])];self.postMessage({type:"GEOJSON_PROCESSED",id:t,data:{type:"FeatureCollection",features:f,bucketExpression:d}});break}default:throw new Error(`Unknown type: ${e}`)}}catch(s){o.aborted||(console.error("[Worker] Error:",s),self.postMessage({type:"ERROR",id:t,error:s instanceof Error?s.message:"Unknown error"}))}};function Z(i){if(i.geometry.type==="Polygon"){const t=i.geometry.coordinates.flat(2),e=t.filter((o,s)=>s%2===0),n=t.filter((o,s)=>s%2!==0);return[Math.min(...e),Math.min(...n),Math.max(...e),Math.max(...n)]}else if(i.geometry.type==="MultiPolygon"){const t=i.geometry.coordinates.flat(3),e=t.filter((o,s)=>s%2===0),n=t.filter((o,s)=>s%2!==0);return[Math.min(...e),Math.min(...n),Math.max(...e),Math.max(...n)]}return[0,0,0,0]}function V(i){const t=["#FFF9B0","#FFE066","#FFB347","#FF7F50","#E84C61","#AD1457","#2E0B59"];return t[i]||t[t.length-1]}})();
