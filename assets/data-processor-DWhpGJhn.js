(function(){"use strict";let a=null;function E(l,c){if(!l)return 0;const r=l[c];return typeof r=="number"&&isFinite(r)?r:0}self.onmessage=async l=>{const{id:c,type:r,data:R}=l.data;a&&(a.abort(),console.log("[Worker] Aborted previous operation")),a=new AbortController;const u=a.signal;try{switch(r){case"LOAD_AND_PROCESS_DATA":{let n=function(e){const s=[...e].filter(t=>t>0).sort((t,o)=>t-o);if(s.length===0)return{min:0,max:1};const d=t=>{const o=Math.floor(t*(s.length-1));return s[o]};return{min:d(.05),max:d(.95)}};const{url:h,selectedMetric:b}=R;console.log(`[Worker] Loading data from: ${h}, metric: ${b}`),self.postMessage({type:"PROGRESS",data:{phase:"Fetching market data..."}});const i=await fetch(h,{signal:u});if(!i.ok)throw new Error(`Fetch failed: ${i.status}`);console.log(`[Worker] Fetch successful, status: ${i.status}`);const y=await i.arrayBuffer();console.log(`[Worker] Received buffer size: ${y.byteLength} bytes`);let k;try{const e=new TextDecoder().decode(y);k=JSON.parse(e),console.log("[Worker] JSON parsed successfully")}catch(e){throw console.error("[Worker] JSON parse failed:",e),new Error("Failed to parse JSON: "+e.message)}const{last_updated_utc:m,zip_codes:f}=k;if(!f)throw new Error("Missing zip_codes data");console.log(`[Worker] Found ${Object.keys(f).length} ZIP codes, last updated: ${m}`),self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes..."}});const g={},w=[],p=Object.entries(f);for(let e=0;e<p.length;e++){if(u.aborted)return;const[s,d]=p[e],t=d??{},o={...t,zipCode:s,latitude:t.latitude??t.lat??null,longitude:t.longitude??t.lng??null};delete o.lat,delete o.lng,g[s]=o;const S=E(o,b);S>0&&w.push(S),e%2e3===0&&self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes...",processed:e,total:p.length}})}const O=n(w);console.log(`[Worker] Data processed: ${Object.keys(g).length} ZIPs, bounds:`,O),self.postMessage({type:"DATA_PROCESSED",id:c,data:{zip_codes:g,last_updated_utc:m,bounds:O}});break}}}catch(n){u.aborted||(console.error("[Worker] Error:",n),self.postMessage({type:"ERROR",id:c,error:n instanceof Error?n.message:"Unknown error"}))}}})();
