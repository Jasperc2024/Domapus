(function(){"use strict";let i=null;function E(_,d){if(!_)return 0;const n=_[d];return typeof n=="number"&&isFinite(n)?n:0}self.onmessage=async _=>{const{id:d,type:n,data:S}=_.data;i&&i.abort(),i=new AbortController;const c=i.signal;try{switch(n){case"LOAD_AND_PROCESS_DATA":{let a=function(o){const t=[...o].filter(e=>e>0).sort((e,l)=>e-l);if(t.length===0)return{min:0,max:1};const s=e=>{const l=Math.floor(e*(t.length-1));return t[l]};return{min:s(.05),max:s(.95)}};const{url:u,selectedMetric:p}=S;self.postMessage({type:"PROGRESS",data:{phase:"Fetching market data..."}});const r=await fetch(u,{signal:c});if(!r.ok)throw r.status===404?new Error("Data file not found. Please try refreshing the page."):r.status>=500?new Error("Server error. Please try again later."):new Error(`Failed to load data (${r.status}). Please try refreshing.`);const g=r.headers.get("content-length");if(g&&parseInt(g)<100)throw new Error("Data file appears to be empty or incomplete. Please try refreshing.");const h=await r.arrayBuffer();if(h.byteLength<100)throw new Error("Received incomplete data. Please check your connection and try again.");let m;try{const o=new TextDecoder().decode(h);if(o.startsWith("version https://git-lfs.github.com"))throw console.error("[Worker] Received Git LFS pointer instead of actual data file"),new Error("Data file not available. The server returned a placeholder instead of actual data. Please try refreshing or contact support.");if(m=JSON.parse(o),!m||typeof m!="object")throw new Error("Invalid data format: expected object")}catch(o){console.error("[Worker] JSON parse failed:",o);const t=o instanceof Error?o.message:"Unknown error",s=t.includes("Unexpected token")||t.includes("JSON")?`JSON parse error: Data file appears corrupted or incomplete (${t})`:`JSON parse error: ${t}`;throw new Error(s)}const{last_updated_utc:O,zip_codes:w}=m;if(!w)throw new Error("Missing zip_codes data");self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes..."}});const y={},v=[],f=Object.entries(w);for(let o=0;o<f.length;o++){if(c.aborted)return;const[t,s]=f[o],e=s??{},l={zipCode:t,city:e.city??null,county:e.county??null,state:e.state??null,metro:e.metro??null,latitude:e.latitude??e.lat??null,longitude:e.longitude??e.lng??null,period_end:e.period_end??null,zhvi:e.zhvi??null,zhvi_mom:e.zhvi_mom??null,zhvi_yoy:e.zhvi_yoy??null,median_sale_price:e.median_sale_price??null,median_sale_price_mom:e.median_sale_price_mom??null,median_sale_price_yoy:e.median_sale_price_yoy??null,median_list_price:e.median_list_price??null,median_list_price_mom:e.median_list_price_mom??null,median_list_price_yoy:e.median_list_price_yoy??null,median_ppsf:e.median_ppsf??null,median_ppsf_mom:e.median_ppsf_mom??null,median_ppsf_yoy:e.median_ppsf_yoy??null,homes_sold:e.homes_sold??null,homes_sold_mom:e.homes_sold_mom??null,homes_sold_yoy:e.homes_sold_yoy??null,pending_sales:e.pending_sales??null,pending_sales_mom:e.pending_sales_mom??null,pending_sales_yoy:e.pending_sales_yoy??null,new_listings:e.new_listings??null,new_listings_mom:e.new_listings_mom??null,new_listings_yoy:e.new_listings_yoy??null,inventory:e.inventory??null,inventory_mom:e.inventory_mom??null,inventory_yoy:e.inventory_yoy??null,median_dom:e.median_dom??null,median_dom_mom:e.median_dom_mom??null,median_dom_yoy:e.median_dom_yoy??null,avg_sale_to_list_ratio:e.avg_sale_to_list_ratio??null,avg_sale_to_list_mom:e.avg_sale_to_list_mom??null,avg_sale_to_list_ratio_yoy:e.avg_sale_to_list_ratio_yoy??null,sold_above_list:e.sold_above_list??null,sold_above_list_mom:e.sold_above_list_mom??null,sold_above_list_yoy:e.sold_above_list_yoy??null,off_market_in_two_weeks:e.off_market_in_two_weeks??null,off_market_in_two_weeks_mom:e.off_market_in_two_weeks_mom??null,off_market_in_two_weeks_yoy:e.off_market_in_two_weeks_yoy??null};y[t]=l;const b=E(l,p);b>0&&v.push(b),o%2e3===0&&self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes...",processed:o,total:f.length}})}const k=a(v);console.log(`[Worker] Data processed: ${Object.keys(y).length} ZIPs, bounds:`,k),self.postMessage({type:"DATA_PROCESSED",id:d,data:{zip_codes:y,last_updated_utc:O,bounds:k}});break}}}catch(a){if(!c.aborted){const u=a instanceof Error?a.message:"Unknown error",p=n||"UNKNOWN";console.error("[Worker] Error:",a),self.postMessage({type:"ERROR",id:d,error:`Worker ${p} error: ${u}`})}}}})();
