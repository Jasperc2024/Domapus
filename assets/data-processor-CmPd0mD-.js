(function(){"use strict";let _=null;function h(i,a){if(!i)return 0;const t=i[a];return typeof t=="number"&&isFinite(t)?t:0}self.onmessage=async i=>{const{id:a,type:t,data:v}=i.data;_&&_.abort(),_=new AbortController;const m=_.signal;try{switch(t){case"LOAD_AND_PROCESS_DATA":{let s=function(o){const n=[...o].filter(e=>e>0).sort((e,l)=>e-l);if(n.length===0)return{min:0,max:1};const r=e=>{const l=Math.floor(e*(n.length-1));return n[l]};return{min:r(.05),max:r(.95)}};const{url:k,selectedMetric:b}=v;self.postMessage({type:"PROGRESS",data:{phase:"Fetching market data..."}});const d=await fetch(k,{signal:m});if(!d.ok)throw new Error(`Fetch failed: ${d.status}`);const E=await d.arrayBuffer();let y;try{const o=new TextDecoder().decode(E);y=JSON.parse(o)}catch(o){throw console.error("[Worker] JSON parse failed:",o),new Error("Failed to parse JSON: "+(o instanceof Error?o.message:"Unknown error"))}const{last_updated_utc:S,zip_codes:p}=y;if(!p)throw new Error("Missing zip_codes data");self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes..."}});const u={},f=[],c=Object.entries(p);for(let o=0;o<c.length;o++){if(m.aborted)return;const[n,r]=c[o],e=r??{},l={zipCode:n,city:e.city??null,county:e.county??null,state:e.state??null,metro:e.metro??null,latitude:e.latitude??e.lat??null,longitude:e.longitude??e.lng??null,period_end:e.period_end??null,zhvi:e.zhvi??null,zhvi_mom:e.zhvi_mom??null,zhvi_yoy:e.zhvi_yoy??null,median_sale_price:e.median_sale_price??null,median_sale_price_mom:e.median_sale_price_mom??null,median_sale_price_yoy:e.median_sale_price_yoy??null,median_list_price:e.median_list_price??null,median_list_price_mom:e.median_list_price_mom??null,median_list_price_yoy:e.median_list_price_yoy??null,median_ppsf:e.median_ppsf??null,median_ppsf_mom:e.median_ppsf_mom??null,median_ppsf_yoy:e.median_ppsf_yoy??null,homes_sold:e.homes_sold??null,homes_sold_mom:e.homes_sold_mom??null,homes_sold_yoy:e.homes_sold_yoy??null,pending_sales:e.pending_sales??null,pending_sales_mom:e.pending_sales_mom??null,pending_sales_yoy:e.pending_sales_yoy??null,new_listings:e.new_listings??null,new_listings_mom:e.new_listings_mom??null,new_listings_yoy:e.new_listings_yoy??null,inventory:e.inventory??null,inventory_mom:e.inventory_mom??null,inventory_yoy:e.inventory_yoy??null,median_dom:e.median_dom??null,median_dom_mom:e.median_dom_mom??null,median_dom_yoy:e.median_dom_yoy??null,avg_sale_to_list_ratio:e.avg_sale_to_list_ratio??null,avg_sale_to_list_mom:e.avg_sale_to_list_mom??null,avg_sale_to_list_ratio_yoy:e.avg_sale_to_list_ratio_yoy??null,sold_above_list:e.sold_above_list??null,sold_above_list_mom:e.sold_above_list_mom??null,sold_above_list_yoy:e.sold_above_list_yoy??null,off_market_in_two_weeks:e.off_market_in_two_weeks??null,off_market_in_two_weeks_mom:e.off_market_in_two_weeks_mom??null,off_market_in_two_weeks_yoy:e.off_market_in_two_weeks_yoy??null};u[n]=l;const w=h(l,b);w>0&&f.push(w),o%2e3===0&&self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes...",processed:o,total:c.length}})}const g=s(f);console.log(`[Worker] Data processed: ${Object.keys(u).length} ZIPs, bounds:`,g),self.postMessage({type:"DATA_PROCESSED",id:a,data:{zip_codes:u,last_updated_utc:S,bounds:g}});break}}}catch(s){m.aborted||(console.error("[Worker] Error:",s),self.postMessage({type:"ERROR",id:a,error:s instanceof Error?s.message:"Unknown error"}))}}})();
