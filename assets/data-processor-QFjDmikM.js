(function(){"use strict";let a=null;function S(l,c){if(!l)return 0;const o=l[c];return typeof o=="number"&&isFinite(o)?o:0}self.onmessage=async l=>{const{id:c,type:o,data:b}=l.data;a&&a.abort(),a=new AbortController;const d=a.signal;try{switch(o){case"LOAD_AND_PROCESS_DATA":{let n=function(e){const s=[...e].filter(t=>t>0).sort((t,r)=>t-r);if(s.length===0)return{min:0,max:1};const i=t=>{const r=Math.floor(t*(s.length-1));return s[r]};return{min:i(.05),max:i(.95)}};const{url:E,selectedMetric:O}=b;self.postMessage({type:"PROGRESS",data:{phase:"Fetching market data..."}});const u=await fetch(E,{signal:d});if(!u.ok)throw new Error(`Fetch failed: ${u.status}`);const R=await u.arrayBuffer();let g;try{const e=new TextDecoder().decode(R);g=JSON.parse(e)}catch(e){throw console.error("[Worker] JSON parse failed:",e),new Error("Failed to parse JSON: "+e.message)}const{last_updated_utc:D,zip_codes:h}=g;if(!h)throw new Error("Missing zip_codes data");self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes..."}});const f={},w=[],p=Object.entries(h);for(let e=0;e<p.length;e++){if(d.aborted)return;const[s,i]=p[e],t=i??{},r={...t,zipCode:s,latitude:t.latitude??t.lat??null,longitude:t.longitude??t.lng??null};delete r.lat,delete r.lng,f[s]=r;const y=S(r,O);y>0&&w.push(y),e%2e3===0&&self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes...",processed:e,total:p.length}})}const m=n(w);console.log(`[Worker] Data processed: ${Object.keys(f).length} ZIPs, bounds:`,m),self.postMessage({type:"DATA_PROCESSED",id:c,data:{zip_codes:f,last_updated_utc:D,bounds:m}});break}}}catch(n){d.aborted||(console.error("[Worker] Error:",n),self.postMessage({type:"ERROR",id:c,error:n instanceof Error?n.message:"Unknown error"}))}}})();
