(function(){"use strict";let l=null;function E(c,n){if(!c)return 0;const s=c[n];return typeof s=="number"&&isFinite(s)?s:0}self.onmessage=async c=>{const{id:n,type:s,data:h}=c.data;console.log(`[Worker] Received message: ${s}`,{id:n,data:h}),l&&(l.abort(),console.log("[Worker] Aborted previous operation")),l=new AbortController;const u=l.signal;try{switch(s){case"LOAD_AND_PROCESS_DATA":{let a=function(e){const r=[...e].filter(t=>t>0).sort((t,o)=>t-o);if(r.length===0)return{min:0,max:1};const d=t=>{const o=Math.floor(t*(r.length-1));return r[o]};return{min:d(.05),max:d(.95)}};const{url:b,selectedMetric:y}=h;console.log(`[Worker] Loading data from: ${b}, metric: ${y}`),self.postMessage({type:"PROGRESS",data:{phase:"Fetching market data..."}});const i=await fetch(b,{signal:u});if(!i.ok)throw new Error(`Fetch failed: ${i.status}`);console.log(`[Worker] Fetch successful, status: ${i.status}`);const k=await i.arrayBuffer();console.log(`[Worker] Received buffer size: ${k.byteLength} bytes`);let m;try{const e=new TextDecoder().decode(k);m=JSON.parse(e),console.log("[Worker] JSON parsed successfully")}catch(e){throw console.error("[Worker] JSON parse failed:",e),new Error("Failed to parse JSON: "+e.message)}const{last_updated_utc:w,zip_codes:f}=m;if(!f)throw new Error("Missing zip_codes data");console.log(`[Worker] Found ${Object.keys(f).length} ZIP codes, last updated: ${w}`),self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes..."}});const g={},O=[],p=Object.entries(f);for(let e=0;e<p.length;e++){if(u.aborted)return;const[r,d]=p[e],t=d??{},o={...t,zipCode:r,latitude:t.latitude??t.lat??null,longitude:t.longitude??t.lng??null};delete o.lat,delete o.lng,g[r]=o;const R=E(o,y);R>0&&O.push(R),e%2e3===0&&self.postMessage({type:"PROGRESS",data:{phase:"Indexing ZIP codes...",processed:e,total:p.length}})}const S=a(O);console.log(`[Worker] Data processed: ${Object.keys(g).length} ZIPs, bounds:`,S),self.postMessage({type:"DATA_PROCESSED",id:n,data:{zip_codes:g,last_updated_utc:w,bounds:S}});break}}}catch(a){u.aborted||(console.error("[Worker] Error:",a),self.postMessage({type:"ERROR",id:n,error:a instanceof Error?a.message:"Unknown error"}))}}})();
